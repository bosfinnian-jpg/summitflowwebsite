<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SummitFlow | Actions</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{
            --bg-deep:#08090A;--bg:#0C0D0F;--bg-card:#131416;--bg-elevated:#1A1B1E;--surface:#222326;
            --border:rgba(255,255,255,0.06);--border-hover:rgba(255,255,255,0.12);
            --text:#F8F8F8;--text-secondary:#A0A0A5;--text-muted:#606065;
            --calls:#FF6B35;--calls-glow:rgba(255,107,53,0.25);
            --emails:#3B82F6;--emails-glow:rgba(59,130,246,0.25);
            --success:#10B981;--success-glow:rgba(16,185,129,0.25);
            --warning:#F59E0B;--warning-glow:rgba(245,158,11,0.25);
            --danger:#EF4444;--danger-glow:rgba(239,68,68,0.25);
            --purple:#8B5CF6;--purple-glow:rgba(139,92,246,0.25);
            --radius:16px;--radius-sm:10px;
        }
        body{font-family:'Space Grotesk',sans-serif;background:var(--bg-deep);color:var(--text);line-height:1.5;min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden;touch-action:pan-y}
        
        .loading{position:fixed;inset:0;background:var(--bg-deep);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .3s}
        .loading.hidden{opacity:0;pointer-events:none}
        .spinner{width:48px;height:48px;border:3px solid var(--surface);border-top-color:var(--calls);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* STICKY HEADER */
        .header{position:sticky;top:0;background:rgba(19,20,22,0.95);border-bottom:1px solid var(--border);padding:1rem 1.5rem;z-index:100;backdrop-filter:blur(20px)}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .logo{font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
        .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--calls),var(--emails));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem}
        .nav-icon{background:var(--surface);border:1px solid var(--border);padding:.5rem .75rem;border-radius:8px;cursor:pointer;font-size:.9rem;text-decoration:none;color:var(--text);transition:all .2s}
        .nav-icon:hover{border-color:var(--border-hover)}
        .time{font-size:.85rem;color:var(--text-muted)}
        .progress-bar{height:8px;background:var(--surface);border-radius:4px;overflow:hidden;margin-bottom:.75rem}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--success),var(--calls));transition:width .3s}
        .stats-row{display:flex;gap:1.5rem;font-size:.85rem}
        .stat{display:flex;align-items:center;gap:.5rem}
        .stat-value{font-weight:700;font-family:'JetBrains Mono',monospace}
        .stat.danger .stat-value{color:var(--danger)}
        
        /* MAIN CONTENT */
        .main{padding:0;max-width:600px;margin:0 auto}
        
        /* CURRENT ACTION CARD */
        .current-action{padding:2rem 1.5rem;min-height:calc(100vh - 200px);display:flex;flex-direction:column;justify-content:center}
        .action-badge{display:inline-block;padding:.375rem .875rem;background:var(--danger-glow);color:var(--danger);border-radius:50px;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:1.5rem;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
        .action-badge.hot{background:var(--calls-glow);color:var(--calls)}
        .action-badge.callback{background:var(--warning-glow);color:var(--warning)}
        
        .action-title{font-size:2rem;font-weight:700;margin-bottom:.75rem;line-height:1.2}
        .action-context{color:var(--text-secondary);font-size:.95rem;margin-bottom:2rem}
        .context-item{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
        
        .contact-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1.25rem;margin-bottom:2rem}
        .contact-name{font-size:1.1rem;font-weight:600;margin-bottom:1rem}
        .contact-item{display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem;font-size:.95rem}
        .contact-item:last-child{margin-bottom:0}
        .contact-item a{color:var(--emails);text-decoration:none;font-weight:500}
        .contact-icon{font-size:1.1rem;width:24px;text-align:center}
        
        /* PRIMARY BUTTON */
        .primary-action{width:100%;padding:1.5rem;font-size:1.25rem;font-weight:700;border-radius:var(--radius);border:none;background:linear-gradient(135deg,var(--calls),#FF8F6B);color:#fff;cursor:pointer;margin-bottom:1.5rem;font-family:inherit;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.75rem;box-shadow:0 8px 25px var(--calls-glow);user-select:none}
        .primary-action:hover{transform:translateY(-4px);box-shadow:0 12px 35px var(--calls-glow)}
        .primary-action:active{transform:translateY(-2px)}
        
        /* SECONDARY ACTIONS */
        .secondary-actions{display:flex;gap:.75rem}
        .secondary-btn{flex:1;padding:1rem;font-size:.9rem;font-weight:600;border-radius:var(--radius-sm);border:2px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem;user-select:none}
        .secondary-btn:hover{border-color:var(--border-hover);background:var(--bg-elevated);transform:translateY(-2px)}
        .secondary-btn:active{transform:translateY(0)}
        .secondary-btn.success{border-color:var(--success);color:var(--success)}
        .secondary-btn.success:hover{background:var(--success);color:#fff}
        
        /* OUTCOME SELECTOR */
        .outcome-panel{margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border);display:none}
        .outcome-panel.active{display:block;animation:slideDown .3s}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .outcome-label{font-size:.9rem;font-weight:600;margin-bottom:1rem;color:var(--text-secondary)}
        .outcome-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1rem}
        .outcome-btn{padding:.875rem;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius-sm);color:var(--text);cursor:pointer;font-size:.85rem;font-weight:500;transition:all .2s;text-align:center;user-select:none}
        .outcome-btn:hover{border-color:var(--calls)}
        .outcome-btn:active{transform:scale(.98)}
        .outcome-btn.selected{border-color:var(--calls);background:var(--calls-glow);color:var(--calls)}
        .notes-input{width:100%;min-height:80px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:.875rem;color:var(--text);font-family:inherit;resize:vertical;margin-bottom:1rem;font-size:.9rem}
        .notes-input:focus{outline:none;border-color:var(--calls)}
        .save-btn{width:100%;padding:1rem;font-size:1rem;font-weight:700;border-radius:var(--radius-sm);border:none;background:var(--success);color:#fff;cursor:pointer;font-family:inherit;transition:all .2s;user-select:none}
        .save-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px var(--success-glow)}
        .save-btn:active{transform:translateY(0)}
        
        /* UP NEXT SECTION */
        .up-next{background:var(--bg-card);border-top:1px solid var(--border);padding:1.5rem;margin-top:2rem}
        .up-next-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .up-next-title{font-size:1rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em}
        .queue-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;margin-bottom:.75rem;cursor:pointer;transition:all .2s;user-select:none}
        .queue-item:hover{border-color:var(--border-hover);transform:translateX(4px)}
        .queue-item:active{transform:translateX(2px)}
        .queue-item:last-child{margin-bottom:0}
        .queue-title{font-weight:600;margin-bottom:.25rem;display:flex;align-items:center;gap:.5rem}
        .queue-meta{font-size:.8rem;color:var(--text-muted)}
        
        /* EMPTY STATE */
        .empty-state{padding:4rem 2rem;text-align:center}
        .empty-icon{font-size:4rem;margin-bottom:1rem}
        .empty-title{font-size:1.5rem;font-weight:700;margin-bottom:.5rem}
        .empty-text{color:var(--text-secondary);margin-bottom:2rem}
        
        /* TOAST */
        .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-card);border:1px solid var(--success);color:var(--text);padding:1rem 2rem;border-radius:50px;font-weight:600;z-index:10000;opacity:0;transition:all .3s;box-shadow:0 8px 25px rgba(0,0,0,.5)}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.error{border-color:var(--danger);color:var(--danger)}
        
        /* KEYBOARD HINT */
        .keyboard-hint{position:fixed;bottom:1rem;right:1rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.5rem .875rem;font-size:.7rem;color:var(--text-muted);opacity:.3;transition:opacity .2s;z-index:50;user-select:none}
        .keyboard-hint:hover{opacity:1}
        
        /* MOBILE OPTIMIZATIONS */
        @media(max-width:768px){
            .header{padding:1rem}
            .current-action{padding:1.5rem 1rem;min-height:calc(100vh - 180px)}
            .action-title{font-size:1.5rem}
            .primary-action{font-size:1.1rem;padding:1.25rem}
            .secondary-actions{gap:.5rem}
            .secondary-btn{padding:.875rem;font-size:.85rem}
            .outcome-grid{grid-template-columns:1fr}
            .keyboard-hint{display:none}
            .stats-row{font-size:.75rem;gap:1rem}
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div style="color:var(--text-secondary);margin-top:1rem">Loading actions...</div>
    </div>
    
    <div class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <span>Actions</span>
            </div>
            <div style="display:flex;gap:.5rem;align-items:center">
                <div class="time" id="current-time"></div>
                <a href="summitflow-pipeline-v2.html" class="nav-icon">‚ò∞</a>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>
        <div class="stats-row">
            <div class="stat">
                <span class="stat-value" id="stat-done">0</span>/<span class="stat-value" id="stat-total">0</span>
                <span>today</span>
            </div>
            <div class="stat danger" id="overdue-stat" style="display:none">
                <span>üî¥</span>
                <span class="stat-value" id="stat-overdue">0</span>
                <span>overdue</span>
            </div>
            <div class="stat">
                <span>üî•</span>
                <span class="stat-value" id="stat-streak">0</span>
            </div>
        </div>
    </div>

    <main class="main">
        <div id="current-action-container"></div>
        
        <div class="up-next" id="up-next-section" style="display:none">
            <div class="up-next-header">
                <div class="up-next-title">Up Next</div>
                <div style="font-size:.85rem;color:var(--text-muted)" id="queue-count">0 actions</div>
            </div>
            <div id="queue-list"></div>
        </div>
    </main>

    <div class="toast" id="toast"></div>
    <div class="keyboard-hint">SPACE=Action ‚Ä¢ D=Done ‚Ä¢ S=Skip ‚Ä¢ N=Next</div>

    <script>
        const SUPABASE_URL = 'https://drxmeoeugymlgadajwmn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyeG1lb2V1Z3ltbGdhZGFqd21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTcxNjEsImV4cCI6MjA4MzAzMzE2MX0.ciWAoTstogM4MWrK73q9VasVWECa9kucCoHlgkyHLIw';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let actions = [];
        let leads = [];
        let currentIndex = 0;
        let showingOutcome = false;
        let selectedOutcome = null;
        
        document.addEventListener('DOMContentLoaded', load);
        
        async function load() {
            try {
                const {data: acts, error: e1} = await db.from('actions').select('*').order('date', {ascending: true});
                if (e1) throw e1;
                actions = acts || [];
                
                const {data: lds, error: e2} = await db.from('leads').select('*');
                if (e2) throw e2;
                leads = lds || [];
                
                console.log('Loaded:', actions.length, 'actions,', leads.length, 'leads');
                
                updateTime();
                setInterval(updateTime, 60000);
                
                renderCurrent();
                setupKeyboard();
                hide();
            } catch(e) {
                console.error(e);
                toast('‚ùå Connection failed', 'error');
                hide();
            }
        }
        
        function hide() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('current-time').textContent = time;
        }
        
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }
        
        function getPriorityActions() {
            const today = getToday();
            let planned = actions.filter(a => a.status === 'planned');
            
            planned.sort((a, b) => {
                if (a.date < today && b.date >= today) return -1;
                if (a.date >= today && b.date < today) return 1;
                if (a.date < today && b.date < today) return a.date.localeCompare(b.date);
                
                const leadA = leads.find(l => l.id === a.lead_id);
                const leadB = leads.find(l => l.id === b.lead_id);
                const hotA = leadA && (leadA.stage === 'interested' || leadA.stage === 'meeting');
                const hotB = leadB && (leadB.stage === 'interested' || leadB.stage === 'meeting');
                if (hotA && !hotB) return -1;
                if (!hotA && hotB) return 1;
                
                const cbA = a.notes && a.notes.toLowerCase().includes('callback');
                const cbB = b.notes && b.notes.toLowerCase().includes('callback');
                if (cbA && !cbB) return -1;
                if (!cbA && cbB) return 1;
                
                return a.date.localeCompare(b.date);
            });
            
            return planned;
        }
        
        function renderCurrent() {
            const priorityActions = getPriorityActions();
            const today = getToday();
            const todayActions = actions.filter(a => a.status === 'planned' && a.date === today);
            const completedToday = actions.filter(a => a.status === 'completed' && a.completed_at && a.completed_at.startsWith(today));
            const overdue = actions.filter(a => a.status === 'planned' && a.date < today);
            
            document.getElementById('stat-done').textContent = completedToday.length;
            document.getElementById('stat-total').textContent = todayActions.length;
            document.getElementById('stat-overdue').textContent = overdue.length;
            document.getElementById('overdue-stat').style.display = overdue.length > 0 ? 'flex' : 'none';
            
            const progress = todayActions.length > 0 ? (completedToday.length / todayActions.length) * 100 : 0;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('stat-streak').textContent = completedToday.length > 0 ? completedToday.length : '0';
            
            const container = document.getElementById('current-action-container');
            
            if (currentIndex >= priorityActions.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéâ</div>
                        <div class="empty-title">All Caught Up!</div>
                        <div class="empty-text">No pending actions. You're crushing it!</div>
                        <button class="primary-action" style="max-width:300px;margin:0 auto" onclick="window.location='summitflow-pipeline-v2.html'">
                            Go to Pipeline
                        </button>
                    </div>
                `;
                document.getElementById('up-next-section').style.display = 'none';
                return;
            }
            
            const action = priorityActions[currentIndex];
            const lead = leads.find(l => l.id === action.lead_id);
            
            if (!lead) {
                currentIndex++;
                renderCurrent();
                return;
            }
            
            const daysSince = Math.floor((new Date(today) - new Date(action.date)) / (1000 * 60 * 60 * 24));
            const isOverdue = action.date < today;
            const isHot = lead.stage === 'interested' || lead.stage === 'meeting';
            const isCallback = action.notes && action.notes.toLowerCase().includes('callback');
            
            let badge = '‚ö° Next Action';
            let badgeClass = '';
            if (isOverdue) {
                badge = `üî¥ ${daysSince} Day${daysSince > 1 ? 's' : ''} Overdue`;
            } else if (isHot) {
                badge = 'üî• Hot Lead';
                badgeClass = 'hot';
            } else if (isCallback) {
                badge = '‚è∞ Callback';
                badgeClass = 'callback';
            }
            
            const typeIcon = {call: 'üìû', email: 'üìß', follow_up: 'üîÑ', meeting: 'ü§ù'}[action.type] || 'üìã';
            const typeName = {call: 'Call', email: 'Email', follow_up: 'Follow up with', meeting: 'Meeting with'}[action.type] || action.type;
            
            container.innerHTML = `
                <div class="current-action">
                    <div class="action-badge ${badgeClass}">${badge}</div>
                    <div class="action-title">${typeIcon} ${typeName} ${lead.company}</div>
                    
                    <div class="action-context">
                        ${lead.last_activity ? `
                            <div class="context-item">
                                <span style="opacity:.5">Last contact:</span>
                                <span>${formatDate(lead.last_activity)}</span>
                                ${lead.last_activity_outcome ? `<span style="opacity:.5">‚Ä¢</span><span>${formatOutcome(lead.last_activity_outcome)}</span>` : ''}
                            </div>
                        ` : ''}
                        ${action.notes ? `<div class="context-item" style="font-style:italic;opacity:.8">"${action.notes}"</div>` : ''}
                    </div>
                    
                    <div class="contact-card">
                        ${lead.contact ? `<div class="contact-name">${lead.contact}</div>` : ''}
                        ${lead.phone ? `
                            <div class="contact-item">
                                <span class="contact-icon">üìû</span>
                                <a href="tel:${lead.phone}">${lead.phone}</a>
                            </div>
                        ` : ''}
                        ${lead.email ? `
                            <div class="contact-item">
                                <span class="contact-icon">üìß</span>
                                <a href="mailto:${lead.email}">${lead.email}</a>
                            </div>
                        ` : ''}
                        ${lead.address ? `
                            <div class="contact-item">
                                <span class="contact-icon">üìç</span>
                                <span style="font-size:.85rem;opacity:.8">${lead.address}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${action.type === 'call' && lead.phone ? `
                        <button class="primary-action" onclick="handlePrimaryAction()">
                            üìû CALL NOW
                        </button>
                    ` : action.type === 'email' && lead.email ? `
                        <button class="primary-action" onclick="handlePrimaryAction()">
                            ‚úâÔ∏è COMPOSE EMAIL
                        </button>
                    ` : `
                        <button class="primary-action" onclick="showOutcomePanel()">
                            ‚úì MARK AS DONE
                        </button>
                    `}
                    
                    <div class="secondary-actions">
                        <button class="secondary-btn success" onclick="showOutcomePanel()">‚úì Done</button>
                        <button class="secondary-btn" onclick="rescheduleAction()">‚è∞ Later</button>
                        <button class="secondary-btn" onclick="skipAction()">Skip</button>
                    </div>
                    
                    <div class="outcome-panel" id="outcome-panel">
                        <div class="outcome-label">What happened?</div>
                        <div class="outcome-grid" id="outcome-grid"></div>
                        <textarea class="notes-input" id="outcome-notes" placeholder="Notes (optional)..."></textarea>
                        <button class="save-btn" onclick="saveOutcome()">Save & Continue</button>
                    </div>
                </div>
            `;
            
            renderQueue(priorityActions);
        }
        
        function renderQueue(priorityActions) {
            const upcoming = priorityActions.slice(currentIndex + 1, currentIndex + 6);
            const list = document.getElementById('queue-list');
            const section = document.getElementById('up-next-section');
            
            if (upcoming.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            document.getElementById('queue-count').textContent = (priorityActions.length - currentIndex - 1) + ' more';
            
            list.innerHTML = upcoming.map(a => {
                const lead = leads.find(l => l.id === a.lead_id);
                if (!lead) return '';
                
                const icon = {call: 'üìû', email: 'üìß', follow_up: 'üîÑ', meeting: 'ü§ù'}[a.type] || 'üìã';
                const isHot = lead.stage === 'interested' || lead.stage === 'meeting';
                
                return `
                    <div class="queue-item" onclick="jumpToAction('${a.id}')">
                        <div class="queue-title">
                            ${icon} ${lead.company}
                            ${isHot ? '<span style="color:var(--calls)">üî•</span>' : ''}
                        </div>
                        <div class="queue-meta">${a.notes || 'Follow-up'}</div>
                    </div>
                `;
            }).join('');
        }
        
        function handlePrimaryAction() {
            const priorityActions = getPriorityActions();
            const action = priorityActions[currentIndex];
            const lead = leads.find(l => l.id === action.lead_id);
            
            if (action.type === 'call' && lead.phone) {
                navigator.clipboard.writeText(lead.phone).then(() => {
                    toast(`üìã ${lead.phone} copied!`);
                });
                window.location.href = `tel:${lead.phone}`;
            } else if (action.type === 'email' && lead.email) {
                const subject = encodeURIComponent(`Following up - SummitFlow`);
                const body = encodeURIComponent(`Hi ${lead.contact || 'there'},\n\n`);
                window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${lead.email}&su=${subject}&body=${body}`, '_blank');
                toast('‚úâÔ∏è Gmail opened');
            }
            
            setTimeout(() => showOutcomePanel(), 500);
        }
        
        function showOutcomePanel() {
            if (showingOutcome) return;
            showingOutcome = true;
            
            const panel = document.getElementById('outcome-panel');
            const priorityActions = getPriorityActions();
            const action = priorityActions[currentIndex];
            
            const outcomes = action.type === 'call' ? [
                {value: 'no_answer', label: 'üìµ No Answer'},
                {value: 'voicemail', label: 'üìû Voicemail'},
                {value: 'gatekeeper', label: 'üö™ Gatekeeper'},
                {value: 'callback', label: '‚è∞ Callback'},
                {value: 'not_interested', label: '‚ùå Not Interested'},
                {value: 'interested', label: 'üî• Interested!'},
                {value: 'meeting', label: 'üéâ Meeting!'}
            ] : [
                {value: 'sent', label: '‚úâÔ∏è Sent'},
                {value: 'bounced', label: '‚ö†Ô∏è Bounced'},
                {value: 'replied', label: 'üí¨ Replied'}
            ];
            
            document.getElementById('outcome-grid').innerHTML = outcomes.map(o => 
                `<button class="outcome-btn" data-outcome="${o.value}" onclick="selectOutcome('${o.value}')">${o.label}</button>`
            ).join('');
            
            panel.classList.add('active');
            panel.scrollIntoView({behavior: 'smooth', block: 'nearest'});
        }
        
        function selectOutcome(outcome) {
            selectedOutcome = outcome;
            document.querySelectorAll('.outcome-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.outcome === outcome) {
                    btn.classList.add('selected');
                }
            });
        }
        
        async function saveOutcome() {
            if (!selectedOutcome) {
                toast('‚ö†Ô∏è Select an outcome', 'error');
                return;
            }
            
            const priorityActions = getPriorityActions();
            const action = priorityActions[currentIndex];
            const notes = document.getElementById('outcome-notes').value;
            
            try {
                await db.from('actions').update({
                    status: 'completed',
                    completed_at: new Date().toISOString()
                }).eq('id', action.id);
                
                await db.from('activities').insert({
                    lead_id: action.lead_id,
                    type: action.type,
                    outcome: selectedOutcome,
                    notes: notes || action.notes || 'Completed'
                });
                
                await db.from('leads').update({
                    last_activity: new Date().toISOString(),
                    last_activity_type: action.type,
                    last_activity_outcome: selectedOutcome
                }).eq('id', action.lead_id);
                
                await createFollowUp(action.lead_id, selectedOutcome, action.type);
                
                action.status = 'completed';
                
                const {data} = await db.from('actions').select('*').order('date', {ascending: true});
                actions = data || [];
                
                showingOutcome = false;
                selectedOutcome = null;
                document.getElementById('outcome-panel').classList.remove('active');
                
                toast('‚úÖ Completed!');
                currentIndex++;
                renderCurrent();
            } catch(e) {
                console.error(e);
                toast('‚ùå Failed: ' + e.message, 'error');
            }
        }
        
        async function createFollowUp(leadId, outcome, type) {
            const today = new Date();
            const followUpDate = new Date(today);
            let offset = 1;
            let actionType = 'call';
            let notes = '';
            
            if (type === 'call') {
                switch(outcome) {
                    case 'no_answer':
                        offset = 1;
                        notes = 'Follow-up after no answer';
                        break;
                    case 'voicemail':
                        offset = 2;
                        notes = 'Follow-up after voicemail';
                        break;
                    case 'callback':
                        offset = 1;
                        notes = 'Callback as requested';
                        break;
                    case 'interested':
                        offset = 1;
                        notes = 'üî• HOT - Follow up immediately';
                        break;
                    case 'meeting':
                        offset = 1;
                        actionType = 'email';
                        notes = 'Send meeting confirmation';
                        break;
                    default:
                        return;
                }
            } else {
                offset = 3;
                notes = 'Check if they saw email';
            }
            
            followUpDate.setDate(followUpDate.getDate() + offset);
            
            await db.from('actions').insert({
                lead_id: leadId,
                type: actionType,
                date: followUpDate.toISOString().split('T')[0],
                notes: notes,
                status: 'planned'
            });
        }
        
        async function skipAction() {
            const priorityActions = getPriorityActions();
            const action = priorityActions[currentIndex];
            
            try {
                await db.from('actions').update({status: 'skipped'}).eq('id', action.id);
                action.status = 'skipped';
                
                toast('‚è≠Ô∏è Skipped');
                currentIndex++;
                renderCurrent();
            } catch(e) {
                console.error(e);
                toast('‚ùå Failed', 'error');
            }
        }
        
        function rescheduleAction() {
            const choice = prompt('Reschedule to:\n1. Tomorrow\n2. In 2 Days\n3. Next Week\n\nEnter 1, 2, or 3:');
            
            if (!choice || choice < 1 || choice > 3) return;
            
            const today = new Date();
            const dates = [1, 2, 7];
            const offset = dates[choice - 1];
            const newDate = new Date(today);
            newDate.setDate(newDate.getDate() + offset);
            
            quickReschedule(newDate.toISOString().split('T')[0]);
        }
        
        async function quickReschedule(newDate) {
            const priorityActions = getPriorityActions();
            const action = priorityActions[currentIndex];
            
            try {
                await db.from('actions').update({date: newDate}).eq('id', action.id);
                action.date = newDate;
                
                const {data} = await db.from('actions').select('*').order('date', {ascending: true});
                actions = data || [];
                
                toast('‚è∞ Rescheduled');
                renderCurrent();
            } catch(e) {
                console.error(e);
                toast('‚ùå Failed', 'error');
            }
        }
        
        function jumpToAction(actionId) {
            const priorityActions = getPriorityActions();
            const index = priorityActions.findIndex(a => a.id === actionId);
            if (index !== -1) {
                currentIndex = index;
                renderCurrent();
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }
        
        function setupKeyboard() {
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
                
                if (e.code === 'Space') {
                    e.preventDefault();
                    handlePrimaryAction();
                } else if (e.key === 'd' || e.key === 'D') {
                    showOutcomePanel();
                } else if (e.key === 's' || e.key === 'S') {
                    skipAction();
                } else if (e.key === 'n' || e.key === 'N') {
                    currentIndex++;
                    renderCurrent();
                }
            });
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const daysDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 0) return 'Today';
            if (daysDiff === 1) return 'Yesterday';
            if (daysDiff < 7) return daysDiff + ' days ago';
            
            return date.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'});
        }
        
        function formatOutcome(outcome) {
            const map = {
                no_answer: 'No Answer',
                voicemail: 'Voicemail',
                callback: 'Callback',
                interested: 'Interested',
                meeting: 'Meeting',
                not_interested: 'Not Interested'
            };
            return map[outcome] || outcome;
        }
        
        function toast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
